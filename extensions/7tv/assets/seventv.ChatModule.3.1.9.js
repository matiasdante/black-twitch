import{u as V,L as ee}from"./seventv.GearsIcon.3.1.9.js";import{g as F,a as te}from"./seventv.ReactHooks.3.1.9.js";import{u as q,a as ne}from"./seventv.useChatEmotes.3.1.9.js";import{d as se}from"./seventv.useModule.3.1.9.js";import{O as G}from"./seventv.Async.3.1.9.js";import{b as re,c as K}from"./seventv.index.3.1.92.js";import{c as oe}from"./seventv.Transform.3.1.9.js";import{p as ae}from"./seventv.ChatMessage.3.1.9.js";import{I as le,a as ie,b as ce,B as W}from"./seventv.UserTag.3.1.9.js";import{d as J}from"./seventv.useCosmetics.3.1.9.js";import{E as ue}from"./seventv.Emote.3.1.9.js";import{u as Y}from"./seventv.TextPaintDirective.3.1.9.js";import{e as R,r as k,f as Q,a as D,ag as P,x as u,l as E,F as L,E as S,B as T,u as x,G as X,m as de,q as N,D as A,Y as j,n as z,_ as $,w as U,J as me,C as fe,X as pe}from"./seventv.index.3.1.9.js";import{_ as he}from"./seventv.ChatData.vue_vue_type_script_setup_true_lang.3.1.9.js";const ve=/^https?:\/\//i,ge=/^\[emote:(?<id>\d+):(?<name>.+)\]$/,Ee=new Set(["w!","h!","v!","z!"]),_e=/( )|(\[emote:\d{1,10}:.{1,30}\])/;function be(f){var C,w;const e=[],r=f.body.split(_e).filter(t=>!!t),l=t=>{var d;if(f.isKick){const p=ge.exec(t);if(p&&p.groups){const{name:c,id:h}=p.groups;return{name:c,id:h,data:oe(h,c),provider:"PLATFORM"}}}if((d=f.localEmoteMap)!=null&&d[t]&&Object.hasOwn(f.localEmoteMap,t))return f.localEmoteMap[t];if(f.emoteMap[t]&&Object.hasOwn(f.emoteMap,t))return f.emoteMap[t]},a=f.showModifiers;let s=-1,i,m=null;const _=(t,d)=>({kind:"VOID",range:[t,d],content:void 0});for(const t of r){const d=s+(t.length+1),p=l(t),c=l(r[r.indexOf(t)+1]),h=l(r[r.indexOf(t)-1]);if(p)(((C=p.data)==null?void 0:C.flags)??0)&256&&i?(i.content.overlaid[p.name]=p,e.push(_(s+1,d-1))):e.push(i={kind:"EMOTE",range:[s+1,d-1],content:{emote:p,overlaid:{},...p.isTwitchCheer?{cheerAmount:p.isTwitchCheer.amount,cheerColor:p.isTwitchCheer.color}:{}}});else if(!a&&c&&Ee.has(t))e.push(_(s,d-1));else if(!a&&h&&t.startsWith("ffz")&&t.length>3)e.push(_(s,d-1));else if(m=ye(t))e.push({kind:"LINK",range:[s+1,d-1],content:{displayText:t,url:m.toString()}});else if(((w=e.at(-1))==null?void 0:w.kind)==="TEXT"){const g=e.at(-1);g.content+=t,g.range=[g.range[0],d-1]}else(t!==" "||!c||!h)&&e.push({kind:"TEXT",range:[s+1,d-1],content:t});s=d,!p&&t&&t!==" "&&(i=void 0)}return e.sort((t,d)=>t.range[0]-d.range[0]),e}function ye(f){try{const e=new URL(`https://${f.replace(ve,"")}`),{isIcann:r,domain:l}=ae(e.hostname);if(l&&r)return e}catch{}return null}const ke={key:0,class:"seventv-text-token"},Ce={key:1},Me=["href"],xe={key:2},Le={key:0,class:"seventv-badge-list"},Te=R({__name:"ChatMessage",props:{bind:{}},emits:["open-card","render"],setup(f,{emit:e}){const r=f,l=e,a=q(),s=ne(a),i=J(r.bind.authorID),m=document.createElement("seventv-container"),_=k([]),C=Q(new WeakMap),w=V("vanity.nametag_paints"),t=V("vanity.7tv_Badges");re(r.bind.usernameEl.parentElement,"click",()=>{l("open-card",r.bind)});function d(c){const h=F(c);return h==null?void 0:h.children.props.content}function p(){_.value.length=0;for(const c of r.bind.texts){const h=d(c);if(!h)continue;const g=be({body:h,chatterMap:{},emoteMap:s.active,localEmoteMap:{...i.emotes},isKick:!0}),b=document.createElement("seventv-container");b.classList.add("seventv-text-token"),c.after(b),c.style.display="none",_.value.push(b),C.set(b,g)}z(()=>l("render"))}return D(()=>r.bind.texts,p,{immediate:!0}),D(()=>r.bind.usernameEl,c=>{c.contains(m)||c.insertAdjacentElement("beforebegin",m)},{immediate:!0}),D([()=>r.bind.usernameEl,i,w],([c,h,g])=>Y(c,g&&h.paints.size?Array.from(h.paints.values())[0].id:null),{immediate:!0}),P(()=>{for(const c of _.value)c.remove();for(const c of r.bind.texts)c.style.display="initial";m.remove()}),(c,h)=>(u(),E(L,null,[(u(!0),E(L,null,S(_.value,(g,b)=>(u(),T(j,{key:b,to:g},[(u(!0),E(L,null,S(C.get(g),(y,n)=>(u(),E(L,{key:n},[x(le)(y)?(u(),E("span",ke,X(y.content),1)):x(ie)(y)?(u(),E("span",Ce,[de("a",{href:y.content.url,target:"_blank",class:"seventv-links",rel:"noopener noreferrer"},X(y.content.url),9,Me)])):x(ce)(y)?(u(),E("span",xe,[N(ue,{class:"seventv-emote-token",emote:y.content.emote,overlaid:y.content.overlaid,format:"WEBP"},null,8,["emote","overlaid"])])):A("",!0)],64))),128))],8,["to"]))),128)),x(t)?(u(),T(j,{key:0,to:x(m)},[x(i).badges.size?(u(),E("span",Le,[(u(!0),E(L,null,S(x(i).badges,([g,b])=>(u(),T(W,{key:g,badge:b,type:"app",alt:b.data.tooltip},null,8,["badge","alt"]))),128))])):A("",!0)],8,["to"])):A("",!0)],64))}}),we=$(Te,[["__scopeId","data-v-5cc9ef42"]]),Ie={key:0,class:"seventv-badge-list"},Oe=R({__name:"ChatUserCard",props:{el:{},bind:{}},setup(f){const e=f,r=J(e.bind.authorID),l=document.createElement("seventv-container");return l.id="seventv-badge-container",l.style.width="100%",U(()=>{const a=e.el.querySelector(".information"),s=e.el.querySelector(".badges-container"),i=e.el.querySelector("a.username");s?s.appendChild(l):a&&a.insertAdjacentElement("afterend",l),i&&r.paints.size&&(i.style.width="fit-content",Y(i,Array.from(r.paints.values())[0].id))}),P(()=>{l.remove()}),(a,s)=>(u(),T(j,{to:x(l)},[x(r).badges.size?(u(),E("span",Ie,[(u(!0),E(L,null,S(x(r).badges,([i,m])=>(u(),T(W,{key:i,badge:m,type:"app",alt:m.data.tooltip},null,8,["badge","alt"]))),128))])):A("",!0)],8,["to"]))}}),Se=$(Oe,[["__scopeId","data-v-3c97e7fe"]]),Be=R({__name:"ChatObserver",props:{listElement:{}},setup(f){const e=f,r=k([]),l=k([]),a=k([]),s=Q(new WeakMap),i=k([]);function m(n){return n!=null&&typeof n=="object"&&"sender"in n&&typeof n.sender=="object"&&"message"in n&&typeof n.message=="object"}function _(n){const v=n.querySelector("div > div[style*='chatroom-font-size']");if(!v)return;const o=F(v);if(!o||!Array.isArray(o.children))return;const M=o.children.find(I=>{var O;return(O=I==null?void 0:I.props)==null?void 0:O.sender});return M==null?void 0:M.props}function C(n,v){if(n.__seventv||!n.hasAttribute("data-index"))return;const o=_(n);if(!o)return;n.__seventv=!0;const M=m(o)?o.messageId:o,I=o.sender.id.toString(),O=o.sender.username,B=n.querySelector("div.inline-flex > button[title]"),Z=n.querySelectorAll("span.font-normal"),H={id:M,authorID:I,authorName:O,texts:Array.from(Z),usernameEl:B,el:n};v||n.classList.add("seventv-chat-message-buffered"),l.value.push(H),s.set(n,H)}async function w(n){const v=document.getElementById("chatroom");if(!v)return;let o=v.querySelector(".user-profile");o||(o=await new G((M,I)=>{for(const O of M)O.addedNodes.forEach(B=>{B instanceof HTMLDivElement&&B.classList.contains("user-profile")&&I(B)})},v,{childList:!0})),i.value.length=0,z(()=>{o&&i.value.push({el:o,bind:n})})}function t(){const n=e.listElement.querySelectorAll("[data-index]");for(const v of Array.from(n))C(v,!0)}const d=k(!1),p=k(e.listElement.getBoundingClientRect());let c=!1;function h(){e.listElement.nextElementSibling&&!c&&(c=!0,e.listElement.addEventListener("click",g)),!d.value&&z(()=>{e.listElement.scrollTo({top:e.listElement.scrollHeight})})}function g(){e.listElement.removeEventListener("click",g),d.value=!1,c=!1}me(()=>{const n=e.listElement;n&&n.addEventListener("wheel",()=>{const v=Math.floor(n.scrollTop),o=Math.floor(n.scrollHeight-p.value.height);if(v>=o-1){d.value=!1;return}d.value=!0})}),P(()=>{e.listElement.removeEventListener("click",g)}),U(()=>{t(),p.value=e.listElement.getBoundingClientRect(),e.listElement.classList.toggle("seventv-chat-observer",!0)});let b=()=>{};D(()=>e.listElement,()=>{b(),b=K(e.listElement,n=>{for(const v of n)v.addedNodes.forEach(o=>{o instanceof HTMLDivElement&&C(o)}),v.removedNodes.forEach(o=>{if(!(o instanceof HTMLDivElement))return;const M=s.get(o);M&&(a.value.push(M),s.delete(o))}),y()},{childList:!0}).stop,y()},{immediate:!0});function y(){if(l.value.length){const n=l.value.splice(0,l.value.length);for(const v of n)v.el.classList.remove("seventv-chat-message-buffered");r.value.push(...n)}if(a.value.length>=25){for(const n of a.value)r.value.splice(r.value.indexOf(n),1);a.value.length=0}h()}return K(e.listElement.parentElement,()=>{e.listElement.nextElementSibling||(d.value=!1)},{childList:!0}),P(()=>{e.listElement.classList.toggle("seventv-chat-observer",!1)}),(n,v)=>(u(),E(L,null,[(u(!0),E(L,null,S(r.value,o=>(u(),T(we,{key:o.id,bind:o,onOpenCard:w},null,8,["bind"]))),128)),(u(!0),E(L,null,S(i.value,o=>(u(),T(Se,{key:o.el,el:o.el,bind:o.bind},null,8,["el","bind"]))),128))],64))}}),De=$(Be,[["__scopeId","data-v-eff2e338"]]),Ae=R({__name:"ChatController",props:{channelId:{},slug:{}},setup(f){const e=f,r=q(e.channelId,!0),l=k(null),a=k(null);let s=null;return U(async()=>{r.setCurrentChannel({id:e.channelId,username:e.slug,displayName:e.slug,active:!0})&&(l.value=null,a.value=null);const m=document.getElementById("chatroom-messages");if(m)if(l.value=m.firstElementChild,s&&s.disconnect(),m.firstElementChild)a.value=m.firstElementChild;else{s=new G((C,w)=>{for(const t of C)!t.target||!(t.target instanceof HTMLDivElement)||t.target.firstElementChild&&w(t.target.firstElementChild)},m,{childList:!0,subtree:!0});const _=await s;a.value=_}}),(i,m)=>(u(),E(L,null,[a.value?(u(),T(De,{key:0,"list-element":a.value},null,8,["list-element"])):A("",!0),N(he)],64))}}),Re=R({__name:"ChatModule",setup(f){const{markAsReady:e}=se("chat",{name:"Chat",depends_on:[]}),r=k(""),l=k("");return q(l.value),D(r,async a=>{if(!a)return;const s=await fetch(`https://kick.com/api/v2/channels/${a}`).catch(m=>{ee.Get().error("failed to fetch channel data",m)});if(!s)return;const{user_id:i}=await s.json();i&&(l.value=i.toString())},{immediate:!0}),te({childSelector:"#chatroom-messages",maxDepth:5,predicate:a=>{var s;return!!((s=a.memoizedProps)!=null&&s.channelSlug)}},{hooks:{render(a,s,i){return r.value=s.channelSlug,(a==null?void 0:a.call(this,s,i))??null}}}),e(),(a,s)=>(u(),T(pe,null,{default:fe(()=>[N(Ae,{ref:"controller","channel-id":l.value,slug:r.value},null,8,["channel-id","slug"])]),_:1}))}}),Je=Object.freeze(Object.defineProperty({__proto__:null,default:Re},Symbol.toStringTag,{value:"Module"}));export{Je as _};
