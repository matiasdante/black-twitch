import{a as te,c as ne}from"./seventv.index.3.1.92.js";import{d as se}from"./seventv.useModule.3.1.9.js";import{b as oe,k as ae}from"./seventv.GearsIcon.3.1.9.js";import{g as K}from"./seventv.Input.3.1.9.js";import{u as re,a as ce}from"./seventv.useChatEmotes.3.1.9.js";import{d as ie}from"./seventv.useCosmetics.3.1.9.js";import{E as le}from"./seventv.Emote.3.1.9.js";import{U as de}from"./seventv.UiFloating.3.1.9.js";import{e as G,r as M,ad as ue,f as J,a as Y,ag as fe,x as O,B as Q,C as me,F as H,q as pe,G as R,m as $,l as N,D as j,E as he,u as z,P as ve,at as ge,a9 as k,_ as _e}from"./seventv.index.3.1.9.js";const xe=["selected","onClick"],Ce={class:"seventv-autocomplete-item-name"},ke={key:0,class:"seventv-autocomplete-item-provider"},ye={key:1,class:"seventv-autocomplete-item-name"},be=G({__name:"ChatInput",props:{anchorEl:{},editor:{}},setup(q){var B;const A=q,I=re(),{sendMessage:y}=oe(),{identity:L}=ae(),b=ce(I),w=ie((L==null?void 0:L.id)??""),P=M(null),m=ue(A,"editor"),a=M(),e=J({active:!1,cursor:"",matches:[],select:0}),u=J({index:-1,messages:[],previous:void 0}),x=M(!1),S=(B=A.editor._nodes.get("text"))==null?void 0:B.klass,g=new Set;function E(){y("CHANNEL_ACTIVE_CHATTER",{channel:k(I)}),u.messages.unshift(A.editor.getEditorState()),U()}function W(o){const d=k(m.value);return Array.from(d._commands.entries()).find(([,t])=>t.find(r=>Array.from(r).find(o)))}const D=te("Shift");function C(o){const d=k(m.value),t=d.getEditorState(),r=t==null?void 0:t._selection,f=t._nodeMap.get("root");!t||!r||d.update(()=>{var c;const[l]=r.getNodes()??[];switch(o.key){case"Tab":case"Enter":o.preventDefault(),e.active?(o.stopPropagation(),F(e.matches[e.select].token),e.active=!1):o.key==="Tab"&&Z(l,r,D.value??void 0);break;case"ArrowUp":case"ArrowDown":{const p=o.key==="ArrowUp"?"up":"down";if(e.active){o.preventDefault(),p==="up"?(e.select===0&&(e.select=e.matches.length),e.select=Math.max(0,e.select-1)):e.select===e.matches.length-1?e.select=0:e.select=Math.min(e.matches.length-1,e.select+1);const n=(c=P.value)==null?void 0:c.children.item(e.select);n==null||n.scrollIntoView({block:"nearest",inline:"nearest"})}else{const n=f.getTextContent(),s=p==="up"?u.index+1:u.index-1;if(s<-1||s>u.messages.length)return;u.previous||(u.previous=t);const _=s<0?k(u.previous):u.messages[s];if(!_||(x.value=!0,p==="up"&&r.focus.offset>1))return;if(p==="down"&&r.focus.offset<n.length)return;d.setEditorState(_),u.index=s,o.preventDefault()}break}case"Escape":e.active=!1;break;default:u.index=-1;break}})}function X(){const t=k(m.value).getEditorState()._selection,[r]=t.getNodes(),f=t.anchor.offset,l=r.getTextContent(),[c,p]=K(l,f),n=l.substring(c,p),s=n.lastIndexOf(":");if(s!==0||n.substring(s).indexOf(" ")!==-1?e.active=!1:e.active=!0,e.active){const _=n.substring(n.lastIndexOf(":")+1)??"";e.cursor=_,e.matches=[...Object.values(b.active),...Object.values(w.emotes),...Object.values(b.byProvider("PLATFORM")).reduce((i,v)=>[...i,...v.emotes],[])].filter(i=>i.name.toLowerCase().includes(_.toLowerCase())).sort((i,v)=>i.name.length-v.name.length).slice(0,25).map(i=>({token:i.unicode||i.name,priority:i.name.length,item:i})),e.matches.length>0&&(x.value=!0),e.select>e.matches.length-1&&(e.select=Math.max(0,e.matches.length-1))}}function F(o){const d=k(m.value);d.focus(()=>{d.update(()=>{const f=d.getEditorState()._selection.anchor,l=f.offset,c=f.getNode(),p=c.getTextContent();if(c instanceof S&&c instanceof S){const n=p.substring(0,l).lastIndexOf(" ",l)+1;c.spliceText(n,Math.abs(l-n),o+" ",!0)}})})}function Z(o,d,t=!1){const r=k(m.value),f=d.anchor.offset,l=o.getTextContent(),[c,p]=K(l,f),n=l.substring(c,p);if(f===c||n.trim().length===0){a.value=void 0;return}const s=a.value;let _,i=0,v;if(!s||s.expectedOffset!==f||s.expectedWord!==n){const V=n.endsWith(" ")?n.slice(0,-1):n;if(v=[...Object.values(b.active),...Object.values(w.emotes),...Object.values(b.byProvider("PLATFORM")).reduce((h,T)=>[...h,...T.emotes],[])].filter(h=>h.name.toLowerCase().startsWith(V.toLowerCase())&&h.provider!=="EMOJI").map(h=>({token:h.unicode||h.name,priority:h.name.length,item:h})),v.sort((h,T)=>h.token.localeCompare(T.token)),_=v[i],v.length===0)return}else v=s.matches,i=t?s.index-1:s.index+1,i%=v.length,t&&i<0&&(i=v.length-1),_=v[i];_?(x.value=!0,r.focus(()=>{r.update(()=>{const h=d.anchor.getNode();if(!(h instanceof S))return;const T=_.token+" ",ee=c+T.length;h.spliceText(c,p-c,T,!0),a.value={index:i,matches:v,currentMatch:_,expectedOffset:ee,expectedWord:T}})}),r.blur()):a.value=void 0}function U(){e.matches=[],e.select=0,e.active=!1,e.cursor="",u.index=-1,u.previous=void 0}return Y(m,o=>{var p;const d=o.registerNodeTransform(S,X);g.add(d);const t=o.registerTextContentListener(()=>{x.value||U(),x.value=!1});g.add(t);const r=W(n=>["preventDefault","dispatchCommand","shiftKey"].every(s=>n.toString().includes(s)));if(r){const[n]=r,s=o.registerCommand(n,()=>(E(),!1),4);g.add(s)}const f=o.registerRootListener((n,s)=>{s==null||s.removeEventListener("keydown",C,{capture:!0}),n==null||n.addEventListener("keydown",C,{capture:!0})});g.add(f);const l=((p=o._nodes.get("text"))==null?void 0:p.transforms)??new Set,c=[...l].find(n=>["chat_emote_suggestion_list"].every(s=>n.toString().includes(s)));c&&l.delete(c)},{immediate:!0}),fe(()=>{for(const o of g)o();g.clear()}),(o,d)=>e.active&&e.matches.length?(O(),Q(de,{key:0,anchor:o.anchorEl,middleware:[z(ve)({crossAxis:!0,mainAxis:!0}),z(ge)({crossAxis:0})],placement:"top-start"},{default:me(()=>[$("div",{ref_key:"colonList",ref:P,class:"seventv-autocomplete-list"},[(O(!0),N(H,null,he(e.matches,(t,r)=>{var f,l;return O(),N("div",{key:(((f=t.item)==null?void 0:f.provider)??"EMOJI")+(((l=t.item)==null?void 0:l.id)??t.token),class:"seventv-autocomplete-item",selected:r===e.select,onClick:c=>F(t.token)},[t.item?(O(),N(H,{key:0},[pe(le,{emote:t.item},null,8,["emote"]),$("span",Ce,R(t.item.name),1),t.item.provider&&t.item.provider!=="EMOJI"&&t.item.provider!=="PLATFORM"?(O(),N("span",ke,"("+R(t.item.provider)+")",1)):j("",!0)],64)):(O(),N("span",ye,R(t.token),1))],8,xe)}),128))],512)]),_:1},8,["anchor","middleware"])):j("",!0)}}),we=_e(be,[["__scopeId","data-v-c43bc35b"]]),Se=G({__name:"ChatInputModule",setup(q,{expose:A}){const{markAsReady:I}=se("chat-input",{name:"Chat Input",depends_on:[]}),y=M(null),L=document.querySelector("div[data-chat] > div:has(div > main)"),b=M(document.querySelector("#channel-chatroom")??null),w=M(null);ne(L,()=>{b.value=document.querySelector("#channel-chatroom")??null},{childList:!0}),Y(b,m=>{const a=(m==null?void 0:m.querySelector("#chat-input-wrapper"))??null;if(w.value=a,a||(y.value=null),!m)return;const e=a==null?void 0:a.querySelector(".editor-input");e&&"__lexicalEditor"in e&&(y.value=e.__lexicalEditor)},{immediate:!0});function P(m){const a=k(y.value);a&&(a.focus(()=>{a.update(()=>{var W,D;const u=a.getEditorState()._nodeMap.get("root"),x=(W=a._nodes.get("text"))==null?void 0:W.klass,S=(D=a._nodes.get("paragraph"))==null?void 0:D.klass,g=u.getLastChild(),E=new x(m);if(g instanceof S){const C=g.getTextContent();g.append(E),C.length!==0&&!C.endsWith(" ")&&E.insertBefore(new x(" ")),E.insertAfter(new x(" ")),g.selectEnd()}else{const C=new S;C.append(E),C.selectEnd(),u.append(C)}})}),a.blur())}return A({appendText:P,container:w}),I(),(m,a)=>w.value&&y.value?(O(),Q(we,{key:0,"anchor-el":w.value,editor:y.value},null,8,["anchor-el","editor"])):j("",!0)}}),We=Object.freeze(Object.defineProperty({__proto__:null,default:Se},Symbol.toStringTag,{value:"Module"}));export{We as _};
