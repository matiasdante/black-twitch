import{O as N}from"./seventv.Async.3.1.9.js";import{b as v,f as E}from"./seventv.ReactHooks.3.1.9.js";import{b as M,u as L,o as h,p as O,q as U,c as V,d as q}from"./seventv.GearsIcon.3.1.9.js";import{d as I}from"./seventv.useModule.3.1.9.js";import{e as P,r as H,f as y,a as g,J as x,ag as F}from"./seventv.index.3.1.9.js";const W=[q("avatars.animation","TOGGLE",{path:["Appearance","Vanity"],label:"Animated Avatars",hint:"Whether or not to allow user avatars to be animated",defaultValue:!0})],j=P({__name:"AvatarsModule",setup(D,{expose:A}){const{markAsReady:w}=I("avatars",{name:"Animated Avatars",depends_on:[]}),{sendMessage:_,target:b}=M(),c=H(),d=y({seen:new Set,pending:new Set}),l=L("avatars.animation"),u=y({});let i;function k(e){d.seen.has(e)||(d.seen.add(e),d.pending.add(e),i||(i=window.setTimeout(()=>{i=void 0;const t=Array.from(d.pending);d.pending.clear(),_("REQUEST_USER_COSMETICS",{identifiers:t.map(n=>["username",n]),kinds:["AVATAR"]})},500)))}async function T(){const e=document.querySelector(".tw-avatar");return e?Promise.resolve(e):new N((t,n)=>{for(const a of t)if(a.addedNodes.length)for(let o=0;o<a.addedNodes.length;o++){const s=a.addedNodes[o];if(!(s instanceof HTMLElement))continue;const r=s.querySelector(".tw-avatar");if(r){n(r);return}}},document.getElementById("root"),{childList:!0,subtree:!0})}async function S(){var n,a;const e=await T();if(!e)return;const t=v(e);!t||!t.return||((a=(n=t.return)==null?void 0:n.return)==null?void 0:a.type).displayName==="Avatar"&&(c.value=t.return.type)}function f(){const e=document.querySelectorAll(".tw-avatar"),t=new Set,n=new Map;for(let a=0;a<e.length;a++){const o=e.item(a),s=v(o);if(!s)continue;let r=s;for(;r;){if(n.has(r)||(n.set(r,r.key),r.key="seventv-rerender"),r.stateNode){if("simplebarRef"in r.stateNode){const[p]=E(r,R=>R.setRootScrollableContentRef!==void 0,void 0,1);if(p){t.add(p);break}}else if("forceUpdate"in r.stateNode){t.add(r.stateNode);break}}r=r.return}}for(const a of t)for(let o=0;o<2;++o)a.forceUpdate();for(const[a,o]of n)a.key=o}function C(e){var o,s;const t=e.props;if(!t||!t.userLogin)return;k(t.userLogin);const n=u[t.userLogin];if(!n||!n.data||!((s=(o=n.data.host)==null?void 0:o.files)!=null&&s.length))return;const a=n.data.host.files.find(r=>r.width&&r.width>64);a&&(t.src=`${n.data.host.url}/${a.name}`)}g(c,(e,t)=>{e&&(t&&h(t,"render"),O(e,"render",function(n,...a){if(l.value){const{children:o}=a[0]??{};if(Array.isArray(o))for(const s of o)!s||!s.type||s.type.displayName!="ImageAvatar"||C(s)}return n==null?void 0:n.apply(n,a)}),f())});function m(e){var n;if(!e.data||!e.data.user||!((n=e.data.user.connections)!=null&&n.length))return;const t=e.data.user.connections.find(a=>a.platform==="TWITCH");t&&(u[t.username]=e)}return U(u,()=>{l.value&&f()},{debounce:350}),g(l,f),b.addEventListener("cosmetic_created",e=>{e.detail.kind==="AVATAR"&&m(e.detail)}),x(()=>{S(),V.cosmetics.where("kind").equals("AVATAR").each(e=>{m(e)})}),F(()=>{c.value&&(h(c.value,"render"),f()),i&&(window.clearTimeout(i),i=void 0)}),A({avatars:u}),w(),(e,t)=>null}}),K=Object.freeze(Object.defineProperty({__proto__:null,config:W,default:j},Symbol.toStringTag,{value:"Module"}));export{K as _};
